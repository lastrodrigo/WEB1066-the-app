language: java
dist: trusty
jdk: oraclejdk8

env:
  - COVERAGE=0.3 SUBPROJECT=ui
  - COVERAGE=0.3 SUBPROJECT=service/cart
  - COVERAGE=0.3 SUBPROJECT=service/user
  - COVERAGE=0.3 SUBPROJECT=repository/order
  - COVERAGE=0.3 SUBPROJECT=repository/cart
  - COVERAGE=0.3 SUBPROJECT=repository/product
  - COVERAGE=0.3 SUBPROJECT=repository/user

stages:
  - script
  - after_script
  - deploy

jobs:
  include:
    - stage: script
      script: ./gradlew clean jar
    - script: find . -name jacocoTestReport.csv|xargs cat|awk -F',' '{print "$3" "$4" "$5"}'
    - stage: after_script
      script: COVERAGE={$COVERAGE} ./gradlew -p ./monolithic/${SUBPROJECT} check
    - stage: deploy
      env: SUBPROJECT=ui
      provider: script
      script: bash scripts/deploy.sh
